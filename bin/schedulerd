#!/usr/bin/env python

# Player daemon
import argparse
import daemon
import lockfile
import logging
import sys

from soundfleet_player.scheduler import Scheduler


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("--no-detach", dest="no_detach", action="store_true")
    args = parser.parse_args()
    return args


def main():
    scheduler = Scheduler()
    scheduler.run()


if __name__ == "__main__":
    args = parse_args()

    if args.no_detach:
        logging.basicConfig(stream=sys.stdout, level=logging.DEBUG)
        main()
    else:
        context = daemon.DaemonContext(
            pidfile=lockfile.FileLock("/var/run/schedulerd.pid")
        )
        with context:
            main()
